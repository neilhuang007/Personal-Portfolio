name: Sync GitHub Stats

on:
  # Run on push to master
  push:
    branches: [master]
    paths:
      - 'scripts/github-sync.js'
      - '.github/workflows/sync-github-stats.yml'

  # Run every 4 days at midnight UTC
  schedule:
    - cron: '0 0 */4 * *'

  # Allow manual trigger
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PORTFOLIO_GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run GitHub sync script
        id: sync
        env:
          GITHUB_TOKEN: ${{ secrets.PORTFOLIO_GITHUB_TOKEN }}
        run: |
          echo "========================================="
          echo "ðŸ”„ Starting GitHub Sync"
          echo "========================================="
          node scripts/github-sync.js 2>&1 | tee sync_output.log
          echo "========================================="
          echo "âœ… Sync script completed"
          echo "========================================="

      - name: Log sync results
        run: |
          echo "========================================="
          echo "ðŸ“Š Sync Results"
          echo "========================================="
          if [ -f info/github-stats.json ]; then
            echo "GitHub Stats JSON exists"
            echo ""
            echo "ðŸ“ Repository Statistics:"
            echo "  Total Repos:     $(jq '.stats.totalRepos' info/github-stats.json)"
            echo "  Public Repos:    $(jq '.repositories | map(select(.isPrivate == false)) | length' info/github-stats.json)"
            echo "  Private Repos:   $(jq '.repositories | map(select(.isPrivate == true)) | length' info/github-stats.json)"
            echo ""
            echo "ðŸ“ Code Statistics:"
            echo "  Total Commits:   $(jq '.stats.totalCommits' info/github-stats.json)"
            echo "  Total Lines:     $(jq '.stats.totalLines' info/github-stats.json)"
            echo "  Total Bytes:     $(jq '.stats.totalBytes' info/github-stats.json)"
            echo ""
            echo "ðŸ”¤ Top 10 Languages:"
            jq -r '.languages[:10] | .[] | "  \(.name): \(.percentage)% (\(.lines) lines)"' info/github-stats.json
            echo ""
            echo "â° Last Synced: $(jq -r '._syncedAt' info/github-stats.json)"
          else
            echo "âŒ github-stats.json not found!"
            exit 1
          fi
          echo "========================================="

      - name: Log projects.json updates
        run: |
          echo "========================================="
          echo "ðŸ“‹ Projects JSON Status"
          echo "========================================="
          if [ -f info/projects.json ]; then
            echo "Total projects: $(jq '.projects | length' info/projects.json)"
            echo "Featured projects: $(jq '.projects | map(select(.featured == true)) | length' info/projects.json)"
            echo ""
            echo "Categories:"
            jq -r '.categories | to_entries[] | "  \(.key): \(.value.count) projects"' info/projects.json
          fi
          echo "========================================="

      - name: Log resume.json updates
        run: |
          echo "========================================="
          echo "ðŸ“„ Resume JSON Status"
          echo "========================================="
          if [ -f info/resume.json ]; then
            echo "Stats section:"
            jq '.stats' info/resume.json
          fi
          echo "========================================="

      - name: Check for changes
        id: changes
        run: |
          echo "========================================="
          echo "ðŸ” Checking for Changes"
          echo "========================================="
          git status
          echo ""
          if git diff --quiet info/; then
            echo "No changes detected in info/"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git diff --stat info/
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
          echo "========================================="

      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          echo "========================================="
          echo "ðŸ“¤ Committing and Pushing Changes"
          echo "========================================="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add info/

          # Create detailed commit message
          REPOS=$(jq '.stats.totalRepos' info/github-stats.json)
          COMMITS=$(jq '.stats.totalCommits' info/github-stats.json)
          LINES=$(jq '.stats.totalLines' info/github-stats.json)

          git commit -m "chore: sync GitHub stats [automated]

Stats updated:
- Repositories: $REPOS
- Total Commits: $COMMITS
- Lines of Code: $LINES

Synced at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"

          git push
          echo "âœ… Changes pushed successfully"
          echo "========================================="

      - name: Generate job summary
        run: |
          echo "# ðŸ“Š GitHub Stats Sync Report" >> $GITHUB_SUMMARY
          echo "" >> $GITHUB_SUMMARY
          echo "**Sync completed at:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_SUMMARY
          echo "" >> $GITHUB_SUMMARY

          if [ -f info/github-stats.json ]; then
            echo "## ðŸ“ Repository Statistics" >> $GITHUB_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_SUMMARY
            echo "|--------|-------|" >> $GITHUB_SUMMARY
            echo "| Total Repositories | $(jq '.stats.totalRepos' info/github-stats.json) |" >> $GITHUB_SUMMARY
            echo "| Total Commits | $(jq '.stats.totalCommits' info/github-stats.json) |" >> $GITHUB_SUMMARY
            echo "| Lines of Code | $(jq '.stats.totalLines' info/github-stats.json) |" >> $GITHUB_SUMMARY
            echo "" >> $GITHUB_SUMMARY

            echo "## ðŸ”¤ Language Breakdown" >> $GITHUB_SUMMARY
            echo "| Language | Percentage | Lines |" >> $GITHUB_SUMMARY
            echo "|----------|------------|-------|" >> $GITHUB_SUMMARY
            jq -r '.languages[:8] | .[] | "| \(.name) | \(.percentage)% | \(.lines) |"' info/github-stats.json >> $GITHUB_SUMMARY
            echo "" >> $GITHUB_SUMMARY

            echo "## ðŸ”„ Changes" >> $GITHUB_SUMMARY
            if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
              echo "âœ… Changes were committed and pushed" >> $GITHUB_SUMMARY
            else
              echo "â„¹ï¸ No changes detected - data is up to date" >> $GITHUB_SUMMARY
            fi
          else
            echo "âŒ Sync failed - github-stats.json not generated" >> $GITHUB_SUMMARY
          fi
